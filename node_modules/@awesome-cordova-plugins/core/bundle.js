'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var rxjs = require('rxjs');

/**
 *
 */
function checkReady() {
    if (typeof process === 'undefined') {
        var win_1 = typeof window !== 'undefined' ? window : {};
        var DEVICE_READY_TIMEOUT_1 = 5000;
        // To help developers using cordova, we listen for the device ready event and
        // log an error if it didn't fire in a reasonable amount of time. Generally,
        // when this happens, developers should remove and reinstall plugins, since
        // an inconsistent plugin is often the culprit.
        var before_1 = Date.now();
        var didFireReady_1 = false;
        win_1.document.addEventListener('deviceready', function () {
            console.log("Ionic Native: deviceready event fired after " + (Date.now() - before_1) + " ms");
            didFireReady_1 = true;
        });
        setTimeout(function () {
            if (!didFireReady_1 && win_1.cordova) {
                console.warn("Ionic Native: deviceready did not fire within " + DEVICE_READY_TIMEOUT_1 + "ms. This can happen when plugins are in an inconsistent state. Try removing plugins from plugins/ and reinstalling them.");
            }
        }, DEVICE_READY_TIMEOUT_1);
    }
}

var ERR_CORDOVA_NOT_AVAILABLE = { error: 'cordova_not_available' };
var ERR_PLUGIN_NOT_INSTALLED = { error: 'plugin_not_installed' };
/**
 * @param callback
 */
function getPromise(callback) {
    var tryNativePromise = function () {
        if (Promise) {
            return new Promise(function (resolve, reject) {
                callback(resolve, reject);
            });
        }
        else {
            console.error('No Promise support or polyfill found. To enable Ionic Native support, please add the es6-promise polyfill before this script, or run with a library like Angular or on a recent browser.');
        }
    };
    if (typeof window !== 'undefined' && window.angular) {
        var doc = window.document;
        var injector = window.angular.element(doc.querySelector('[ng-app]') || doc.body).injector();
        if (injector) {
            var $q = injector.get('$q');
            return $q(function (resolve, reject) {
                callback(resolve, reject);
            });
        }
        console.warn("Angular 1 was detected but $q couldn't be retrieved. This is usually when the app is not bootstrapped on the html or body tag. Falling back to native promises which won't trigger an automatic digest when promises resolve.");
    }
    return tryNativePromise();
}
/**
 * @param pluginObj
 * @param methodName
 * @param args
 * @param opts
 */
function wrapPromise(pluginObj, methodName, args, opts) {
    if (opts === void 0) { opts = {}; }
    var pluginResult, rej;
    var p = getPromise(function (resolve, reject) {
        if (opts.destruct) {
            pluginResult = callCordovaPlugin(pluginObj, methodName, args, opts, function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return resolve(args);
            }, function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return reject(args);
            });
        }
        else {
            pluginResult = callCordovaPlugin(pluginObj, methodName, args, opts, resolve, reject);
        }
        rej = reject;
    });
    // Angular throws an error on unhandled rejection, but in this case we have already printed
    // a warning that Cordova is undefined or the plugin is uninstalled, so there is no reason
    // to error
    if (pluginResult && pluginResult.error) {
        p.catch(function () { });
        typeof rej === 'function' && rej(pluginResult.error);
    }
    return p;
}
/**
 * @param pluginObj
 * @param methodName
 * @param args
 * @param opts
 */
function wrapOtherPromise(pluginObj, methodName, args, opts) {
    if (opts === void 0) { opts = {}; }
    return getPromise(function (resolve, reject) {
        var pluginResult = callCordovaPlugin(pluginObj, methodName, args, opts);
        if (pluginResult) {
            if (pluginResult.error) {
                reject(pluginResult.error);
            }
            else if (pluginResult.then) {
                pluginResult.then(resolve).catch(reject);
            }
        }
        else {
            reject({ error: 'unexpected_error' });
        }
    });
}
/**
 * @param pluginObj
 * @param methodName
 * @param args
 * @param opts
 */
function wrapObservable(pluginObj, methodName, args, opts) {
    if (opts === void 0) { opts = {}; }
    return new rxjs.Observable(function (observer) {
        var pluginResult;
        if (opts.destruct) {
            pluginResult = callCordovaPlugin(pluginObj, methodName, args, opts, function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return observer.next(args);
            }, function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return observer.error(args);
            });
        }
        else {
            pluginResult = callCordovaPlugin(pluginObj, methodName, args, opts, observer.next.bind(observer), observer.error.bind(observer));
        }
        if (pluginResult && pluginResult.error) {
            observer.error(pluginResult.error);
            observer.complete();
        }
        return function () {
            try {
                if (opts.clearFunction) {
                    if (opts.clearWithArgs) {
                        return callCordovaPlugin(pluginObj, opts.clearFunction, args, opts, observer.next.bind(observer), observer.error.bind(observer));
                    }
                    return callCordovaPlugin(pluginObj, opts.clearFunction, []);
                }
            }
            catch (e) {
                console.warn('Unable to clear the previous observable watch for', pluginObj.constructor.getPluginName(), methodName);
                console.warn(e);
            }
        };
    });
}
/**
 * Wrap the event with an observable
 *
 * @private
 * @param event event name
 * @param element The element to attach the event listener to
 * @returns {Observable}
 */
function wrapEventObservable(event, element) {
    element =
        typeof window !== 'undefined' && element
            ? get$1(window, element)
            : element || (typeof window !== 'undefined' ? window : {});
    return rxjs.fromEvent(element, event);
}
/**
 * @param plugin
 * @param methodName
 * @param pluginName
 */
function checkAvailability(plugin, methodName, pluginName) {
    var pluginRef, pluginPackage;
    if (typeof plugin === 'string') {
        pluginRef = plugin;
    }
    else {
        pluginRef = plugin.constructor.getPluginRef();
        pluginName = plugin.constructor.getPluginName();
        pluginPackage = plugin.constructor.getPluginInstallName();
    }
    var pluginInstance = getPlugin(pluginRef);
    if (!pluginInstance || (!!methodName && typeof pluginInstance[methodName] === 'undefined')) {
        if (typeof window === 'undefined' || !window.cordova) {
            cordovaWarn(pluginName, methodName);
            return ERR_CORDOVA_NOT_AVAILABLE;
        }
        pluginWarn(pluginName, pluginPackage, methodName);
        return ERR_PLUGIN_NOT_INSTALLED;
    }
    return true;
}
/**
 * Checks if _objectInstance exists and has the method/property
 *
 * @param pluginObj
 * @param methodName
 * @private
 */
function instanceAvailability(pluginObj, methodName) {
    return pluginObj._objectInstance && (!methodName || typeof pluginObj._objectInstance[methodName] !== 'undefined');
}
/**
 * @param args
 * @param opts
 * @param resolve
 * @param reject
 */
function setIndex(args, opts, resolve, reject) {
    if (opts === void 0) { opts = {}; }
    // ignore resolve and reject in case sync
    if (opts.sync) {
        return args;
    }
    // If the plugin method expects myMethod(success, err, options)
    if (opts.callbackOrder === 'reverse') {
        // Get those arguments in the order [resolve, reject, ...restOfArgs]
        args.unshift(reject);
        args.unshift(resolve);
    }
    else if (opts.callbackStyle === 'node') {
        args.push(function (err, result) {
            if (err) {
                reject(err);
            }
            else {
                resolve(result);
            }
        });
    }
    else if (opts.callbackStyle === 'object' && opts.successName && opts.errorName) {
        var obj = {};
        obj[opts.successName] = resolve;
        obj[opts.errorName] = reject;
        args.push(obj);
    }
    else if (typeof opts.successIndex !== 'undefined' || typeof opts.errorIndex !== 'undefined') {
        var setSuccessIndex = function () {
            // If we've specified a success/error index
            if (opts.successIndex > args.length) {
                args[opts.successIndex] = resolve;
            }
            else {
                args.splice(opts.successIndex, 0, resolve);
            }
        };
        var setErrorIndex = function () {
            // We don't want that the reject cb gets spliced into the position of an optional argument that has not been
            // defined and thus causing non expected behavior.
            if (opts.errorIndex > args.length) {
                args[opts.errorIndex] = reject; // insert the reject fn at the correct specific index
            }
            else {
                args.splice(opts.errorIndex, 0, reject); // otherwise just splice it into the array
            }
        };
        if (opts.successIndex > opts.errorIndex) {
            setErrorIndex();
            setSuccessIndex();
        }
        else {
            setSuccessIndex();
            setErrorIndex();
        }
    }
    else {
        // Otherwise, let's tack them on to the end of the argument list
        // which is 90% of cases
        args.push(resolve);
        args.push(reject);
    }
    return args;
}
/**
 * @param pluginObj
 * @param methodName
 * @param args
 * @param opts
 * @param resolve
 * @param reject
 */
function callCordovaPlugin(pluginObj, methodName, args, opts, resolve, reject) {
    if (opts === void 0) { opts = {}; }
    // Try to figure out where the success/error callbacks need to be bound
    // to our promise resolve/reject handlers.
    args = setIndex(args, opts, resolve, reject);
    var availabilityCheck = checkAvailability(pluginObj, methodName);
    if (availabilityCheck === true) {
        var pluginInstance = getPlugin(pluginObj.constructor.getPluginRef());
        // eslint-disable-next-line prefer-spread
        return pluginInstance[methodName].apply(pluginInstance, args);
    }
    else {
        return availabilityCheck;
    }
}
/**
 * @param pluginObj
 * @param methodName
 * @param args
 * @param opts
 * @param resolve
 * @param reject
 */
function callInstance(pluginObj, methodName, args, opts, resolve, reject) {
    if (opts === void 0) { opts = {}; }
    args = setIndex(args, opts, resolve, reject);
    if (instanceAvailability(pluginObj, methodName)) {
        // eslint-disable-next-line prefer-spread
        return pluginObj._objectInstance[methodName].apply(pluginObj._objectInstance, args);
    }
}
/**
 * @param pluginRef
 */
function getPlugin(pluginRef) {
    if (typeof window !== 'undefined') {
        return get$1(window, pluginRef);
    }
    return null;
}
/**
 * @param element
 * @param path
 */
function get$1(element, path) {
    var paths = path.split('.');
    var obj = element;
    for (var i = 0; i < paths.length; i++) {
        if (!obj) {
            return null;
        }
        obj = obj[paths[i]];
    }
    return obj;
}
/**
 * @param pluginName
 * @param plugin
 * @param method
 */
function pluginWarn(pluginName, plugin, method) {
    if (method) {
        console.warn('Native: tried calling ' + pluginName + '.' + method + ', but the ' + pluginName + ' plugin is not installed.');
    }
    else {
        console.warn("Native: tried accessing the " + pluginName + " plugin but it's not installed.");
    }
    if (plugin) {
        console.warn("Install the " + pluginName + " plugin: 'ionic cordova plugin add " + plugin + "'");
    }
}
/**
 * @private
 * @param pluginName
 * @param method
 */
function cordovaWarn(pluginName, method) {
    if (typeof process === 'undefined') {
        if (method) {
            console.warn('Native: tried calling ' +
                pluginName +
                '.' +
                method +
                ', but Cordova is not available. Make sure to include cordova.js or run in a device/simulator');
        }
        else {
            console.warn('Native: tried accessing the ' +
                pluginName +
                ' plugin but Cordova is not available. Make sure to include cordova.js or run in a device/simulator');
        }
    }
}
/**
 * @param pluginObj
 * @param methodName
 * @param opts
 * @private
 */
var wrap = function (pluginObj, methodName, opts) {
    if (opts === void 0) { opts = {}; }
    return function () {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        if (opts.sync) {
            // Sync doesn't wrap the plugin with a promise or observable, it returns the result as-is
            return callCordovaPlugin(pluginObj, methodName, args, opts);
        }
        else if (opts.observable) {
            return wrapObservable(pluginObj, methodName, args, opts);
        }
        else if (opts.eventObservable && opts.event) {
            return wrapEventObservable(opts.event, opts.element);
        }
        else if (opts.otherPromise) {
            return wrapOtherPromise(pluginObj, methodName, args, opts);
        }
        else {
            return wrapPromise(pluginObj, methodName, args, opts);
        }
    };
};
/**
 * @param pluginObj
 * @param methodName
 * @param opts
 * @private
 */
function wrapInstance(pluginObj, methodName, opts) {
    if (opts === void 0) { opts = {}; }
    return function () {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        if (opts.sync) {
            return callInstance(pluginObj, methodName, args, opts);
        }
        else if (opts.observable) {
            return new rxjs.Observable(function (observer) {
                var pluginResult;
                if (opts.destruct) {
                    pluginResult = callInstance(pluginObj, methodName, args, opts, function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        return observer.next(args);
                    }, function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        return observer.error(args);
                    });
                }
                else {
                    pluginResult = callInstance(pluginObj, methodName, args, opts, observer.next.bind(observer), observer.error.bind(observer));
                }
                if (pluginResult && pluginResult.error) {
                    observer.error(pluginResult.error);
                }
                return function () {
                    try {
                        if (opts.clearWithArgs) {
                            return callInstance(pluginObj, opts.clearFunction, args, opts, observer.next.bind(observer), observer.error.bind(observer));
                        }
                        return callInstance(pluginObj, opts.clearFunction, []);
                    }
                    catch (e) {
                        console.warn('Unable to clear the previous observable watch for', pluginObj.constructor.getPluginName(), methodName);
                        console.warn(e);
                    }
                };
            });
        }
        else if (opts.otherPromise) {
            return getPromise(function (resolve, reject) {
                var result;
                if (opts.destruct) {
                    result = callInstance(pluginObj, methodName, args, opts, function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        return resolve(args);
                    }, function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        return reject(args);
                    });
                }
                else {
                    result = callInstance(pluginObj, methodName, args, opts, resolve, reject);
                }
                if (result && result.then) {
                    result.then(resolve, reject);
                }
                else {
                    reject();
                }
            });
        }
        else {
            var pluginResult_1, rej_1;
            var p = getPromise(function (resolve, reject) {
                if (opts.destruct) {
                    pluginResult_1 = callInstance(pluginObj, methodName, args, opts, function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        return resolve(args);
                    }, function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        return reject(args);
                    });
                }
                else {
                    pluginResult_1 = callInstance(pluginObj, methodName, args, opts, resolve, reject);
                }
                rej_1 = reject;
            });
            // Angular throws an error on unhandled rejection, but in this case we have already printed
            // a warning that Cordova is undefined or the plugin is uninstalled, so there is no reason
            // to error
            if (pluginResult_1 && pluginResult_1.error) {
                p.catch(function () { });
                typeof rej_1 === 'function' && rej_1(pluginResult_1.error);
            }
            return p;
        }
    };
}

/**
 * @param element
 * @param path
 * @private
 */
function get(element, path) {
    var paths = path.split('.');
    var obj = element;
    for (var i = 0; i < paths.length; i++) {
        if (!obj) {
            return null;
        }
        obj = obj[paths[i]];
    }
    return obj;
}

var AwesomeCordovaNativePlugin = /** @class */ (function () {
    function AwesomeCordovaNativePlugin() {
    }
    /**
     * Returns a boolean that indicates whether the plugin is installed
     *
     * @returns {boolean}
     */
    AwesomeCordovaNativePlugin.installed = function () {
        var isAvailable = checkAvailability(this.pluginRef) === true;
        return isAvailable;
    };
    /**
     * Returns the original plugin object
     */
    AwesomeCordovaNativePlugin.getPlugin = function () {
        if (typeof window !== 'undefined') {
            return get(window, this.pluginRef);
        }
        return null;
    };
    /**
     * Returns the plugin's name
     */
    AwesomeCordovaNativePlugin.getPluginName = function () {
        var pluginName = this.pluginName;
        return pluginName;
    };
    /**
     * Returns the plugin's reference
     */
    AwesomeCordovaNativePlugin.getPluginRef = function () {
        var pluginRef = this.pluginRef;
        return pluginRef;
    };
    /**
     * Returns the plugin's install name
     */
    AwesomeCordovaNativePlugin.getPluginInstallName = function () {
        var plugin = this.plugin;
        return plugin;
    };
    /**
     * Returns the plugin's supported platforms
     */
    AwesomeCordovaNativePlugin.getSupportedPlatforms = function () {
        var platform = this.platforms;
        return platform;
    };
    AwesomeCordovaNativePlugin.pluginName = '';
    AwesomeCordovaNativePlugin.pluginRef = '';
    AwesomeCordovaNativePlugin.plugin = '';
    AwesomeCordovaNativePlugin.repo = '';
    AwesomeCordovaNativePlugin.platforms = [];
    AwesomeCordovaNativePlugin.install = '';
    return AwesomeCordovaNativePlugin;
}());

/**
 * @param pluginObj
 * @param methodName
 * @param config
 * @param args
 */
function cordova(pluginObj, methodName, config, args) {
    return wrap(pluginObj, methodName, config).apply(this, args);
}

/**
 * @param pluginObj
 * @param methodName
 */
function overrideFunction(pluginObj, methodName) {
    return new rxjs.Observable(function (observer) {
        var availabilityCheck = checkAvailability(pluginObj, methodName);
        if (availabilityCheck === true) {
            var pluginInstance_1 = getPlugin(pluginObj.constructor.getPluginRef());
            pluginInstance_1[methodName] = observer.next.bind(observer);
            return function () { return (pluginInstance_1[methodName] = function () { }); };
        }
        else {
            observer.error(availabilityCheck);
            observer.complete();
        }
    });
}
/**
 * @param pluginObj
 * @param methodName
 * @param args
 */
function cordovaFunctionOverride(pluginObj, methodName, args) {
    return overrideFunction(pluginObj, methodName);
}

/**
 * @param pluginObj
 * @param methodName
 * @param config
 * @param args
 */
function cordovaInstance(pluginObj, methodName, config, args) {
    args = Array.from(args);
    return wrapInstance(pluginObj, methodName, config).apply(this, args);
}

/**
 * @param pluginObj
 * @param key
 */
function cordovaPropertyGet(pluginObj, key) {
    if (checkAvailability(pluginObj, key) === true) {
        return getPlugin(pluginObj.constructor.getPluginRef())[key];
    }
    return null;
}
/**
 * @param pluginObj
 * @param key
 * @param value
 */
function cordovaPropertySet(pluginObj, key, value) {
    if (checkAvailability(pluginObj, key) === true) {
        getPlugin(pluginObj.constructor.getPluginRef())[key] = value;
    }
}

/**
 * @param pluginObj
 * @param key
 */
function instancePropertyGet(pluginObj, key) {
    if (pluginObj._objectInstance && pluginObj._objectInstance[key]) {
        return pluginObj._objectInstance[key];
    }
    return null;
}
/**
 * @param pluginObj
 * @param key
 * @param value
 */
function instancePropertySet(pluginObj, key, value) {
    if (pluginObj._objectInstance) {
        pluginObj._objectInstance[key] = value;
    }
}

checkReady();

exports.AwesomeCordovaNativePlugin = AwesomeCordovaNativePlugin;
exports.checkAvailability = checkAvailability;
exports.cordova = cordova;
exports.cordovaFunctionOverride = cordovaFunctionOverride;
exports.cordovaInstance = cordovaInstance;
exports.cordovaPropertyGet = cordovaPropertyGet;
exports.cordovaPropertySet = cordovaPropertySet;
exports.getPromise = getPromise;
exports.instanceAvailability = instanceAvailability;
exports.instancePropertyGet = instancePropertyGet;
exports.instancePropertySet = instancePropertySet;
exports.wrap = wrap;

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlcyI6WyJidW5kbGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pO1xuXG52YXIgcnhqcyA9IHJlcXVpcmUoJ3J4anMnKTtcblxuLyoqXG4gKlxuICovXG5mdW5jdGlvbiBjaGVja1JlYWR5KCkge1xuICAgIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdmFyIHdpbl8xID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgPyB3aW5kb3cgOiB7fTtcbiAgICAgICAgdmFyIERFVklDRV9SRUFEWV9USU1FT1VUXzEgPSA1MDAwO1xuICAgICAgICAvLyBUbyBoZWxwIGRldmVsb3BlcnMgdXNpbmcgY29yZG92YSwgd2UgbGlzdGVuIGZvciB0aGUgZGV2aWNlIHJlYWR5IGV2ZW50IGFuZFxuICAgICAgICAvLyBsb2cgYW4gZXJyb3IgaWYgaXQgZGlkbid0IGZpcmUgaW4gYSByZWFzb25hYmxlIGFtb3VudCBvZiB0aW1lLiBHZW5lcmFsbHksXG4gICAgICAgIC8vIHdoZW4gdGhpcyBoYXBwZW5zLCBkZXZlbG9wZXJzIHNob3VsZCByZW1vdmUgYW5kIHJlaW5zdGFsbCBwbHVnaW5zLCBzaW5jZVxuICAgICAgICAvLyBhbiBpbmNvbnNpc3RlbnQgcGx1Z2luIGlzIG9mdGVuIHRoZSBjdWxwcml0LlxuICAgICAgICB2YXIgYmVmb3JlXzEgPSBEYXRlLm5vdygpO1xuICAgICAgICB2YXIgZGlkRmlyZVJlYWR5XzEgPSBmYWxzZTtcbiAgICAgICAgd2luXzEuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlcmVhZHknLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIklvbmljIE5hdGl2ZTogZGV2aWNlcmVhZHkgZXZlbnQgZmlyZWQgYWZ0ZXIgXCIgKyAoRGF0ZS5ub3coKSAtIGJlZm9yZV8xKSArIFwiIG1zXCIpO1xuICAgICAgICAgICAgZGlkRmlyZVJlYWR5XzEgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoIWRpZEZpcmVSZWFkeV8xICYmIHdpbl8xLmNvcmRvdmEpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJJb25pYyBOYXRpdmU6IGRldmljZXJlYWR5IGRpZCBub3QgZmlyZSB3aXRoaW4gXCIgKyBERVZJQ0VfUkVBRFlfVElNRU9VVF8xICsgXCJtcy4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gcGx1Z2lucyBhcmUgaW4gYW4gaW5jb25zaXN0ZW50IHN0YXRlLiBUcnkgcmVtb3ZpbmcgcGx1Z2lucyBmcm9tIHBsdWdpbnMvIGFuZCByZWluc3RhbGxpbmcgdGhlbS5cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIERFVklDRV9SRUFEWV9USU1FT1VUXzEpO1xuICAgIH1cbn1cblxudmFyIEVSUl9DT1JET1ZBX05PVF9BVkFJTEFCTEUgPSB7IGVycm9yOiAnY29yZG92YV9ub3RfYXZhaWxhYmxlJyB9O1xudmFyIEVSUl9QTFVHSU5fTk9UX0lOU1RBTExFRCA9IHsgZXJyb3I6ICdwbHVnaW5fbm90X2luc3RhbGxlZCcgfTtcbi8qKlxuICogQHBhcmFtIGNhbGxiYWNrXG4gKi9cbmZ1bmN0aW9uIGdldFByb21pc2UoY2FsbGJhY2spIHtcbiAgICB2YXIgdHJ5TmF0aXZlUHJvbWlzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKFByb21pc2UpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2socmVzb2x2ZSwgcmVqZWN0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignTm8gUHJvbWlzZSBzdXBwb3J0IG9yIHBvbHlmaWxsIGZvdW5kLiBUbyBlbmFibGUgSW9uaWMgTmF0aXZlIHN1cHBvcnQsIHBsZWFzZSBhZGQgdGhlIGVzNi1wcm9taXNlIHBvbHlmaWxsIGJlZm9yZSB0aGlzIHNjcmlwdCwgb3IgcnVuIHdpdGggYSBsaWJyYXJ5IGxpa2UgQW5ndWxhciBvciBvbiBhIHJlY2VudCBicm93c2VyLicpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LmFuZ3VsYXIpIHtcbiAgICAgICAgdmFyIGRvYyA9IHdpbmRvdy5kb2N1bWVudDtcbiAgICAgICAgdmFyIGluamVjdG9yID0gd2luZG93LmFuZ3VsYXIuZWxlbWVudChkb2MucXVlcnlTZWxlY3RvcignW25nLWFwcF0nKSB8fCBkb2MuYm9keSkuaW5qZWN0b3IoKTtcbiAgICAgICAgaWYgKGluamVjdG9yKSB7XG4gICAgICAgICAgICB2YXIgJHEgPSBpbmplY3Rvci5nZXQoJyRxJyk7XG4gICAgICAgICAgICByZXR1cm4gJHEoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLndhcm4oXCJBbmd1bGFyIDEgd2FzIGRldGVjdGVkIGJ1dCAkcSBjb3VsZG4ndCBiZSByZXRyaWV2ZWQuIFRoaXMgaXMgdXN1YWxseSB3aGVuIHRoZSBhcHAgaXMgbm90IGJvb3RzdHJhcHBlZCBvbiB0aGUgaHRtbCBvciBib2R5IHRhZy4gRmFsbGluZyBiYWNrIHRvIG5hdGl2ZSBwcm9taXNlcyB3aGljaCB3b24ndCB0cmlnZ2VyIGFuIGF1dG9tYXRpYyBkaWdlc3Qgd2hlbiBwcm9taXNlcyByZXNvbHZlLlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRyeU5hdGl2ZVByb21pc2UoKTtcbn1cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIG1ldGhvZE5hbWVcbiAqIEBwYXJhbSBhcmdzXG4gKiBAcGFyYW0gb3B0c1xuICovXG5mdW5jdGlvbiB3cmFwUHJvbWlzZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMpIHtcbiAgICBpZiAob3B0cyA9PT0gdm9pZCAwKSB7IG9wdHMgPSB7fTsgfVxuICAgIHZhciBwbHVnaW5SZXN1bHQsIHJlajtcbiAgICB2YXIgcCA9IGdldFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBpZiAob3B0cy5kZXN0cnVjdCkge1xuICAgICAgICAgICAgcGx1Z2luUmVzdWx0ID0gY2FsbENvcmRvdmFQbHVnaW4ocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xuICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGFyZ3MpO1xuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGFyZ3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBwbHVnaW5SZXN1bHQgPSBjYWxsQ29yZG92YVBsdWdpbihwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMsIHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVqID0gcmVqZWN0O1xuICAgIH0pO1xuICAgIC8vIEFuZ3VsYXIgdGhyb3dzIGFuIGVycm9yIG9uIHVuaGFuZGxlZCByZWplY3Rpb24sIGJ1dCBpbiB0aGlzIGNhc2Ugd2UgaGF2ZSBhbHJlYWR5IHByaW50ZWRcbiAgICAvLyBhIHdhcm5pbmcgdGhhdCBDb3Jkb3ZhIGlzIHVuZGVmaW5lZCBvciB0aGUgcGx1Z2luIGlzIHVuaW5zdGFsbGVkLCBzbyB0aGVyZSBpcyBubyByZWFzb25cbiAgICAvLyB0byBlcnJvclxuICAgIGlmIChwbHVnaW5SZXN1bHQgJiYgcGx1Z2luUmVzdWx0LmVycm9yKSB7XG4gICAgICAgIHAuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTtcbiAgICAgICAgdHlwZW9mIHJlaiA9PT0gJ2Z1bmN0aW9uJyAmJiByZWoocGx1Z2luUmVzdWx0LmVycm9yKTtcbiAgICB9XG4gICAgcmV0dXJuIHA7XG59XG4vKipcbiAqIEBwYXJhbSBwbHVnaW5PYmpcbiAqIEBwYXJhbSBtZXRob2ROYW1lXG4gKiBAcGFyYW0gYXJnc1xuICogQHBhcmFtIG9wdHNcbiAqL1xuZnVuY3Rpb24gd3JhcE90aGVyUHJvbWlzZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMpIHtcbiAgICBpZiAob3B0cyA9PT0gdm9pZCAwKSB7IG9wdHMgPSB7fTsgfVxuICAgIHJldHVybiBnZXRQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgdmFyIHBsdWdpblJlc3VsdCA9IGNhbGxDb3Jkb3ZhUGx1Z2luKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgYXJncywgb3B0cyk7XG4gICAgICAgIGlmIChwbHVnaW5SZXN1bHQpIHtcbiAgICAgICAgICAgIGlmIChwbHVnaW5SZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZWplY3QocGx1Z2luUmVzdWx0LmVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKHBsdWdpblJlc3VsdC50aGVuKSB7XG4gICAgICAgICAgICAgICAgcGx1Z2luUmVzdWx0LnRoZW4ocmVzb2x2ZSkuY2F0Y2gocmVqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdCh7IGVycm9yOiAndW5leHBlY3RlZF9lcnJvcicgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIG1ldGhvZE5hbWVcbiAqIEBwYXJhbSBhcmdzXG4gKiBAcGFyYW0gb3B0c1xuICovXG5mdW5jdGlvbiB3cmFwT2JzZXJ2YWJsZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMpIHtcbiAgICBpZiAob3B0cyA9PT0gdm9pZCAwKSB7IG9wdHMgPSB7fTsgfVxuICAgIHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChvYnNlcnZlcikge1xuICAgICAgICB2YXIgcGx1Z2luUmVzdWx0O1xuICAgICAgICBpZiAob3B0cy5kZXN0cnVjdCkge1xuICAgICAgICAgICAgcGx1Z2luUmVzdWx0ID0gY2FsbENvcmRvdmFQbHVnaW4ocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xuICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBvYnNlcnZlci5uZXh0KGFyZ3MpO1xuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gb2JzZXJ2ZXIuZXJyb3IoYXJncyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHBsdWdpblJlc3VsdCA9IGNhbGxDb3Jkb3ZhUGx1Z2luKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgYXJncywgb3B0cywgb2JzZXJ2ZXIubmV4dC5iaW5kKG9ic2VydmVyKSwgb2JzZXJ2ZXIuZXJyb3IuYmluZChvYnNlcnZlcikpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwbHVnaW5SZXN1bHQgJiYgcGx1Z2luUmVzdWx0LmVycm9yKSB7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihwbHVnaW5SZXN1bHQuZXJyb3IpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5jbGVhckZ1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmNsZWFyV2l0aEFyZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsQ29yZG92YVBsdWdpbihwbHVnaW5PYmosIG9wdHMuY2xlYXJGdW5jdGlvbiwgYXJncywgb3B0cywgb2JzZXJ2ZXIubmV4dC5iaW5kKG9ic2VydmVyKSwgb2JzZXJ2ZXIuZXJyb3IuYmluZChvYnNlcnZlcikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsQ29yZG92YVBsdWdpbihwbHVnaW5PYmosIG9wdHMuY2xlYXJGdW5jdGlvbiwgW10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdVbmFibGUgdG8gY2xlYXIgdGhlIHByZXZpb3VzIG9ic2VydmFibGUgd2F0Y2ggZm9yJywgcGx1Z2luT2JqLmNvbnN0cnVjdG9yLmdldFBsdWdpbk5hbWUoKSwgbWV0aG9kTmFtZSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH0pO1xufVxuLyoqXG4gKiBXcmFwIHRoZSBldmVudCB3aXRoIGFuIG9ic2VydmFibGVcbiAqXG4gKiBAcHJpdmF0ZVxuICogQHBhcmFtIGV2ZW50IGV2ZW50IG5hbWVcbiAqIEBwYXJhbSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGF0dGFjaCB0aGUgZXZlbnQgbGlzdGVuZXIgdG9cbiAqIEByZXR1cm5zIHtPYnNlcnZhYmxlfVxuICovXG5mdW5jdGlvbiB3cmFwRXZlbnRPYnNlcnZhYmxlKGV2ZW50LCBlbGVtZW50KSB7XG4gICAgZWxlbWVudCA9XG4gICAgICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIGVsZW1lbnRcbiAgICAgICAgICAgID8gZ2V0JDEod2luZG93LCBlbGVtZW50KVxuICAgICAgICAgICAgOiBlbGVtZW50IHx8ICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHt9KTtcbiAgICByZXR1cm4gcnhqcy5mcm9tRXZlbnQoZWxlbWVudCwgZXZlbnQpO1xufVxuLyoqXG4gKiBAcGFyYW0gcGx1Z2luXG4gKiBAcGFyYW0gbWV0aG9kTmFtZVxuICogQHBhcmFtIHBsdWdpbk5hbWVcbiAqL1xuZnVuY3Rpb24gY2hlY2tBdmFpbGFiaWxpdHkocGx1Z2luLCBtZXRob2ROYW1lLCBwbHVnaW5OYW1lKSB7XG4gICAgdmFyIHBsdWdpblJlZiwgcGx1Z2luUGFja2FnZTtcbiAgICBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcGx1Z2luUmVmID0gcGx1Z2luO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcGx1Z2luUmVmID0gcGx1Z2luLmNvbnN0cnVjdG9yLmdldFBsdWdpblJlZigpO1xuICAgICAgICBwbHVnaW5OYW1lID0gcGx1Z2luLmNvbnN0cnVjdG9yLmdldFBsdWdpbk5hbWUoKTtcbiAgICAgICAgcGx1Z2luUGFja2FnZSA9IHBsdWdpbi5jb25zdHJ1Y3Rvci5nZXRQbHVnaW5JbnN0YWxsTmFtZSgpO1xuICAgIH1cbiAgICB2YXIgcGx1Z2luSW5zdGFuY2UgPSBnZXRQbHVnaW4ocGx1Z2luUmVmKTtcbiAgICBpZiAoIXBsdWdpbkluc3RhbmNlIHx8ICghIW1ldGhvZE5hbWUgJiYgdHlwZW9mIHBsdWdpbkluc3RhbmNlW21ldGhvZE5hbWVdID09PSAndW5kZWZpbmVkJykpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnIHx8ICF3aW5kb3cuY29yZG92YSkge1xuICAgICAgICAgICAgY29yZG92YVdhcm4ocGx1Z2luTmFtZSwgbWV0aG9kTmFtZSk7XG4gICAgICAgICAgICByZXR1cm4gRVJSX0NPUkRPVkFfTk9UX0FWQUlMQUJMRTtcbiAgICAgICAgfVxuICAgICAgICBwbHVnaW5XYXJuKHBsdWdpbk5hbWUsIHBsdWdpblBhY2thZ2UsIG1ldGhvZE5hbWUpO1xuICAgICAgICByZXR1cm4gRVJSX1BMVUdJTl9OT1RfSU5TVEFMTEVEO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cbi8qKlxuICogQ2hlY2tzIGlmIF9vYmplY3RJbnN0YW5jZSBleGlzdHMgYW5kIGhhcyB0aGUgbWV0aG9kL3Byb3BlcnR5XG4gKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIG1ldGhvZE5hbWVcbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIGluc3RhbmNlQXZhaWxhYmlsaXR5KHBsdWdpbk9iaiwgbWV0aG9kTmFtZSkge1xuICAgIHJldHVybiBwbHVnaW5PYmouX29iamVjdEluc3RhbmNlICYmICghbWV0aG9kTmFtZSB8fCB0eXBlb2YgcGx1Z2luT2JqLl9vYmplY3RJbnN0YW5jZVttZXRob2ROYW1lXSAhPT0gJ3VuZGVmaW5lZCcpO1xufVxuLyoqXG4gKiBAcGFyYW0gYXJnc1xuICogQHBhcmFtIG9wdHNcbiAqIEBwYXJhbSByZXNvbHZlXG4gKiBAcGFyYW0gcmVqZWN0XG4gKi9cbmZ1bmN0aW9uIHNldEluZGV4KGFyZ3MsIG9wdHMsIHJlc29sdmUsIHJlamVjdCkge1xuICAgIGlmIChvcHRzID09PSB2b2lkIDApIHsgb3B0cyA9IHt9OyB9XG4gICAgLy8gaWdub3JlIHJlc29sdmUgYW5kIHJlamVjdCBpbiBjYXNlIHN5bmNcbiAgICBpZiAob3B0cy5zeW5jKSB7XG4gICAgICAgIHJldHVybiBhcmdzO1xuICAgIH1cbiAgICAvLyBJZiB0aGUgcGx1Z2luIG1ldGhvZCBleHBlY3RzIG15TWV0aG9kKHN1Y2Nlc3MsIGVyciwgb3B0aW9ucylcbiAgICBpZiAob3B0cy5jYWxsYmFja09yZGVyID09PSAncmV2ZXJzZScpIHtcbiAgICAgICAgLy8gR2V0IHRob3NlIGFyZ3VtZW50cyBpbiB0aGUgb3JkZXIgW3Jlc29sdmUsIHJlamVjdCwgLi4ucmVzdE9mQXJnc11cbiAgICAgICAgYXJncy51bnNoaWZ0KHJlamVjdCk7XG4gICAgICAgIGFyZ3MudW5zaGlmdChyZXNvbHZlKTtcbiAgICB9XG4gICAgZWxzZSBpZiAob3B0cy5jYWxsYmFja1N0eWxlID09PSAnbm9kZScpIHtcbiAgICAgICAgYXJncy5wdXNoKGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSBpZiAob3B0cy5jYWxsYmFja1N0eWxlID09PSAnb2JqZWN0JyAmJiBvcHRzLnN1Y2Nlc3NOYW1lICYmIG9wdHMuZXJyb3JOYW1lKSB7XG4gICAgICAgIHZhciBvYmogPSB7fTtcbiAgICAgICAgb2JqW29wdHMuc3VjY2Vzc05hbWVdID0gcmVzb2x2ZTtcbiAgICAgICAgb2JqW29wdHMuZXJyb3JOYW1lXSA9IHJlamVjdDtcbiAgICAgICAgYXJncy5wdXNoKG9iaik7XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGVvZiBvcHRzLnN1Y2Nlc3NJbmRleCAhPT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIG9wdHMuZXJyb3JJbmRleCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdmFyIHNldFN1Y2Nlc3NJbmRleCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIElmIHdlJ3ZlIHNwZWNpZmllZCBhIHN1Y2Nlc3MvZXJyb3IgaW5kZXhcbiAgICAgICAgICAgIGlmIChvcHRzLnN1Y2Nlc3NJbmRleCA+IGFyZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgYXJnc1tvcHRzLnN1Y2Nlc3NJbmRleF0gPSByZXNvbHZlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgYXJncy5zcGxpY2Uob3B0cy5zdWNjZXNzSW5kZXgsIDAsIHJlc29sdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB2YXIgc2V0RXJyb3JJbmRleCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhhdCB0aGUgcmVqZWN0IGNiIGdldHMgc3BsaWNlZCBpbnRvIHRoZSBwb3NpdGlvbiBvZiBhbiBvcHRpb25hbCBhcmd1bWVudCB0aGF0IGhhcyBub3QgYmVlblxuICAgICAgICAgICAgLy8gZGVmaW5lZCBhbmQgdGh1cyBjYXVzaW5nIG5vbiBleHBlY3RlZCBiZWhhdmlvci5cbiAgICAgICAgICAgIGlmIChvcHRzLmVycm9ySW5kZXggPiBhcmdzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGFyZ3Nbb3B0cy5lcnJvckluZGV4XSA9IHJlamVjdDsgLy8gaW5zZXJ0IHRoZSByZWplY3QgZm4gYXQgdGhlIGNvcnJlY3Qgc3BlY2lmaWMgaW5kZXhcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKG9wdHMuZXJyb3JJbmRleCwgMCwgcmVqZWN0KTsgLy8gb3RoZXJ3aXNlIGp1c3Qgc3BsaWNlIGl0IGludG8gdGhlIGFycmF5XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGlmIChvcHRzLnN1Y2Nlc3NJbmRleCA+IG9wdHMuZXJyb3JJbmRleCkge1xuICAgICAgICAgICAgc2V0RXJyb3JJbmRleCgpO1xuICAgICAgICAgICAgc2V0U3VjY2Vzc0luZGV4KCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBzZXRTdWNjZXNzSW5kZXgoKTtcbiAgICAgICAgICAgIHNldEVycm9ySW5kZXgoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgLy8gT3RoZXJ3aXNlLCBsZXQncyB0YWNrIHRoZW0gb24gdG8gdGhlIGVuZCBvZiB0aGUgYXJndW1lbnQgbGlzdFxuICAgICAgICAvLyB3aGljaCBpcyA5MCUgb2YgY2FzZXNcbiAgICAgICAgYXJncy5wdXNoKHJlc29sdmUpO1xuICAgICAgICBhcmdzLnB1c2gocmVqZWN0KTtcbiAgICB9XG4gICAgcmV0dXJuIGFyZ3M7XG59XG4vKipcbiAqIEBwYXJhbSBwbHVnaW5PYmpcbiAqIEBwYXJhbSBtZXRob2ROYW1lXG4gKiBAcGFyYW0gYXJnc1xuICogQHBhcmFtIG9wdHNcbiAqIEBwYXJhbSByZXNvbHZlXG4gKiBAcGFyYW0gcmVqZWN0XG4gKi9cbmZ1bmN0aW9uIGNhbGxDb3Jkb3ZhUGx1Z2luKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgYXJncywgb3B0cywgcmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgaWYgKG9wdHMgPT09IHZvaWQgMCkgeyBvcHRzID0ge307IH1cbiAgICAvLyBUcnkgdG8gZmlndXJlIG91dCB3aGVyZSB0aGUgc3VjY2Vzcy9lcnJvciBjYWxsYmFja3MgbmVlZCB0byBiZSBib3VuZFxuICAgIC8vIHRvIG91ciBwcm9taXNlIHJlc29sdmUvcmVqZWN0IGhhbmRsZXJzLlxuICAgIGFyZ3MgPSBzZXRJbmRleChhcmdzLCBvcHRzLCByZXNvbHZlLCByZWplY3QpO1xuICAgIHZhciBhdmFpbGFiaWxpdHlDaGVjayA9IGNoZWNrQXZhaWxhYmlsaXR5KHBsdWdpbk9iaiwgbWV0aG9kTmFtZSk7XG4gICAgaWYgKGF2YWlsYWJpbGl0eUNoZWNrID09PSB0cnVlKSB7XG4gICAgICAgIHZhciBwbHVnaW5JbnN0YW5jZSA9IGdldFBsdWdpbihwbHVnaW5PYmouY29uc3RydWN0b3IuZ2V0UGx1Z2luUmVmKCkpO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLXNwcmVhZFxuICAgICAgICByZXR1cm4gcGx1Z2luSW5zdGFuY2VbbWV0aG9kTmFtZV0uYXBwbHkocGx1Z2luSW5zdGFuY2UsIGFyZ3MpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGF2YWlsYWJpbGl0eUNoZWNrO1xuICAgIH1cbn1cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIG1ldGhvZE5hbWVcbiAqIEBwYXJhbSBhcmdzXG4gKiBAcGFyYW0gb3B0c1xuICogQHBhcmFtIHJlc29sdmVcbiAqIEBwYXJhbSByZWplY3RcbiAqL1xuZnVuY3Rpb24gY2FsbEluc3RhbmNlKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgYXJncywgb3B0cywgcmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgaWYgKG9wdHMgPT09IHZvaWQgMCkgeyBvcHRzID0ge307IH1cbiAgICBhcmdzID0gc2V0SW5kZXgoYXJncywgb3B0cywgcmVzb2x2ZSwgcmVqZWN0KTtcbiAgICBpZiAoaW5zdGFuY2VBdmFpbGFiaWxpdHkocGx1Z2luT2JqLCBtZXRob2ROYW1lKSkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLXNwcmVhZFxuICAgICAgICByZXR1cm4gcGx1Z2luT2JqLl9vYmplY3RJbnN0YW5jZVttZXRob2ROYW1lXS5hcHBseShwbHVnaW5PYmouX29iamVjdEluc3RhbmNlLCBhcmdzKTtcbiAgICB9XG59XG4vKipcbiAqIEBwYXJhbSBwbHVnaW5SZWZcbiAqL1xuZnVuY3Rpb24gZ2V0UGx1Z2luKHBsdWdpblJlZikge1xuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICByZXR1cm4gZ2V0JDEod2luZG93LCBwbHVnaW5SZWYpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn1cbi8qKlxuICogQHBhcmFtIGVsZW1lbnRcbiAqIEBwYXJhbSBwYXRoXG4gKi9cbmZ1bmN0aW9uIGdldCQxKGVsZW1lbnQsIHBhdGgpIHtcbiAgICB2YXIgcGF0aHMgPSBwYXRoLnNwbGl0KCcuJyk7XG4gICAgdmFyIG9iaiA9IGVsZW1lbnQ7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRocy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoIW9iaikge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgb2JqID0gb2JqW3BhdGhzW2ldXTtcbiAgICB9XG4gICAgcmV0dXJuIG9iajtcbn1cbi8qKlxuICogQHBhcmFtIHBsdWdpbk5hbWVcbiAqIEBwYXJhbSBwbHVnaW5cbiAqIEBwYXJhbSBtZXRob2RcbiAqL1xuZnVuY3Rpb24gcGx1Z2luV2FybihwbHVnaW5OYW1lLCBwbHVnaW4sIG1ldGhvZCkge1xuICAgIGlmIChtZXRob2QpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdOYXRpdmU6IHRyaWVkIGNhbGxpbmcgJyArIHBsdWdpbk5hbWUgKyAnLicgKyBtZXRob2QgKyAnLCBidXQgdGhlICcgKyBwbHVnaW5OYW1lICsgJyBwbHVnaW4gaXMgbm90IGluc3RhbGxlZC4nKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcIk5hdGl2ZTogdHJpZWQgYWNjZXNzaW5nIHRoZSBcIiArIHBsdWdpbk5hbWUgKyBcIiBwbHVnaW4gYnV0IGl0J3Mgbm90IGluc3RhbGxlZC5cIik7XG4gICAgfVxuICAgIGlmIChwbHVnaW4pIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiSW5zdGFsbCB0aGUgXCIgKyBwbHVnaW5OYW1lICsgXCIgcGx1Z2luOiAnaW9uaWMgY29yZG92YSBwbHVnaW4gYWRkIFwiICsgcGx1Z2luICsgXCInXCIpO1xuICAgIH1cbn1cbi8qKlxuICogQHByaXZhdGVcbiAqIEBwYXJhbSBwbHVnaW5OYW1lXG4gKiBAcGFyYW0gbWV0aG9kXG4gKi9cbmZ1bmN0aW9uIGNvcmRvdmFXYXJuKHBsdWdpbk5hbWUsIG1ldGhvZCkge1xuICAgIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgaWYgKG1ldGhvZCkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdOYXRpdmU6IHRyaWVkIGNhbGxpbmcgJyArXG4gICAgICAgICAgICAgICAgcGx1Z2luTmFtZSArXG4gICAgICAgICAgICAgICAgJy4nICtcbiAgICAgICAgICAgICAgICBtZXRob2QgK1xuICAgICAgICAgICAgICAgICcsIGJ1dCBDb3Jkb3ZhIGlzIG5vdCBhdmFpbGFibGUuIE1ha2Ugc3VyZSB0byBpbmNsdWRlIGNvcmRvdmEuanMgb3IgcnVuIGluIGEgZGV2aWNlL3NpbXVsYXRvcicpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdOYXRpdmU6IHRyaWVkIGFjY2Vzc2luZyB0aGUgJyArXG4gICAgICAgICAgICAgICAgcGx1Z2luTmFtZSArXG4gICAgICAgICAgICAgICAgJyBwbHVnaW4gYnV0IENvcmRvdmEgaXMgbm90IGF2YWlsYWJsZS4gTWFrZSBzdXJlIHRvIGluY2x1ZGUgY29yZG92YS5qcyBvciBydW4gaW4gYSBkZXZpY2Uvc2ltdWxhdG9yJyk7XG4gICAgICAgIH1cbiAgICB9XG59XG4vKipcbiAqIEBwYXJhbSBwbHVnaW5PYmpcbiAqIEBwYXJhbSBtZXRob2ROYW1lXG4gKiBAcGFyYW0gb3B0c1xuICogQHByaXZhdGVcbiAqL1xudmFyIHdyYXAgPSBmdW5jdGlvbiAocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBvcHRzKSB7XG4gICAgaWYgKG9wdHMgPT09IHZvaWQgMCkgeyBvcHRzID0ge307IH1cbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgYXJncyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xuICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICB9XG4gICAgICAgIGlmIChvcHRzLnN5bmMpIHtcbiAgICAgICAgICAgIC8vIFN5bmMgZG9lc24ndCB3cmFwIHRoZSBwbHVnaW4gd2l0aCBhIHByb21pc2Ugb3Igb2JzZXJ2YWJsZSwgaXQgcmV0dXJucyB0aGUgcmVzdWx0IGFzLWlzXG4gICAgICAgICAgICByZXR1cm4gY2FsbENvcmRvdmFQbHVnaW4ocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChvcHRzLm9ic2VydmFibGUpIHtcbiAgICAgICAgICAgIHJldHVybiB3cmFwT2JzZXJ2YWJsZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKG9wdHMuZXZlbnRPYnNlcnZhYmxlICYmIG9wdHMuZXZlbnQpIHtcbiAgICAgICAgICAgIHJldHVybiB3cmFwRXZlbnRPYnNlcnZhYmxlKG9wdHMuZXZlbnQsIG9wdHMuZWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAob3B0cy5vdGhlclByb21pc2UpIHtcbiAgICAgICAgICAgIHJldHVybiB3cmFwT3RoZXJQcm9taXNlKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgYXJncywgb3B0cyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gd3JhcFByb21pc2UocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzKTtcbiAgICAgICAgfVxuICAgIH07XG59O1xuLyoqXG4gKiBAcGFyYW0gcGx1Z2luT2JqXG4gKiBAcGFyYW0gbWV0aG9kTmFtZVxuICogQHBhcmFtIG9wdHNcbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIHdyYXBJbnN0YW5jZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIG9wdHMpIHtcbiAgICBpZiAob3B0cyA9PT0gdm9pZCAwKSB7IG9wdHMgPSB7fTsgfVxuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBhcmdzID0gW107XG4gICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XG4gICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9wdHMuc3luYykge1xuICAgICAgICAgICAgcmV0dXJuIGNhbGxJbnN0YW5jZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKG9wdHMub2JzZXJ2YWJsZSkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyByeGpzLk9ic2VydmFibGUoZnVuY3Rpb24gKG9ic2VydmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBsdWdpblJlc3VsdDtcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5kZXN0cnVjdCkge1xuICAgICAgICAgICAgICAgICAgICBwbHVnaW5SZXN1bHQgPSBjYWxsSW5zdGFuY2UocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JzZXJ2ZXIubmV4dChhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ic2VydmVyLmVycm9yKGFyZ3MpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBsdWdpblJlc3VsdCA9IGNhbGxJbnN0YW5jZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGFyZ3MsIG9wdHMsIG9ic2VydmVyLm5leHQuYmluZChvYnNlcnZlciksIG9ic2VydmVyLmVycm9yLmJpbmQob2JzZXJ2ZXIpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBsdWdpblJlc3VsdCAmJiBwbHVnaW5SZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IocGx1Z2luUmVzdWx0LmVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLmNsZWFyV2l0aEFyZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbEluc3RhbmNlKHBsdWdpbk9iaiwgb3B0cy5jbGVhckZ1bmN0aW9uLCBhcmdzLCBvcHRzLCBvYnNlcnZlci5uZXh0LmJpbmQob2JzZXJ2ZXIpLCBvYnNlcnZlci5lcnJvci5iaW5kKG9ic2VydmVyKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbEluc3RhbmNlKHBsdWdpbk9iaiwgb3B0cy5jbGVhckZ1bmN0aW9uLCBbXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignVW5hYmxlIHRvIGNsZWFyIHRoZSBwcmV2aW91cyBvYnNlcnZhYmxlIHdhdGNoIGZvcicsIHBsdWdpbk9iai5jb25zdHJ1Y3Rvci5nZXRQbHVnaW5OYW1lKCksIG1ldGhvZE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKG9wdHMub3RoZXJQcm9taXNlKSB7XG4gICAgICAgICAgICByZXR1cm4gZ2V0UHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdDtcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5kZXN0cnVjdCkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBjYWxsSW5zdGFuY2UocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBjYWxsSW5zdGFuY2UocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzLCByZXNvbHZlLCByZWplY3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC50aGVuKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHZhciBwbHVnaW5SZXN1bHRfMSwgcmVqXzE7XG4gICAgICAgICAgICB2YXIgcCA9IGdldFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIGlmIChvcHRzLmRlc3RydWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHBsdWdpblJlc3VsdF8xID0gY2FsbEluc3RhbmNlKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgYXJncywgb3B0cywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoYXJncyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoYXJncyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGx1Z2luUmVzdWx0XzEgPSBjYWxsSW5zdGFuY2UocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzLCBvcHRzLCByZXNvbHZlLCByZWplY3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZWpfMSA9IHJlamVjdDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gQW5ndWxhciB0aHJvd3MgYW4gZXJyb3Igb24gdW5oYW5kbGVkIHJlamVjdGlvbiwgYnV0IGluIHRoaXMgY2FzZSB3ZSBoYXZlIGFscmVhZHkgcHJpbnRlZFxuICAgICAgICAgICAgLy8gYSB3YXJuaW5nIHRoYXQgQ29yZG92YSBpcyB1bmRlZmluZWQgb3IgdGhlIHBsdWdpbiBpcyB1bmluc3RhbGxlZCwgc28gdGhlcmUgaXMgbm8gcmVhc29uXG4gICAgICAgICAgICAvLyB0byBlcnJvclxuICAgICAgICAgICAgaWYgKHBsdWdpblJlc3VsdF8xICYmIHBsdWdpblJlc3VsdF8xLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgcC5jYXRjaChmdW5jdGlvbiAoKSB7IH0pO1xuICAgICAgICAgICAgICAgIHR5cGVvZiByZWpfMSA9PT0gJ2Z1bmN0aW9uJyAmJiByZWpfMShwbHVnaW5SZXN1bHRfMS5lcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcDtcbiAgICAgICAgfVxuICAgIH07XG59XG5cbi8qKlxuICogQHBhcmFtIGVsZW1lbnRcbiAqIEBwYXJhbSBwYXRoXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBnZXQoZWxlbWVudCwgcGF0aCkge1xuICAgIHZhciBwYXRocyA9IHBhdGguc3BsaXQoJy4nKTtcbiAgICB2YXIgb2JqID0gZWxlbWVudDtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGhzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmICghb2JqKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBvYmogPSBvYmpbcGF0aHNbaV1dO1xuICAgIH1cbiAgICByZXR1cm4gb2JqO1xufVxuXG52YXIgQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4gPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4oKSB7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFJldHVybnMgYSBib29sZWFuIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgdGhlIHBsdWdpbiBpcyBpbnN0YWxsZWRcbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIEF3ZXNvbWVDb3Jkb3ZhTmF0aXZlUGx1Z2luLmluc3RhbGxlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGlzQXZhaWxhYmxlID0gY2hlY2tBdmFpbGFiaWxpdHkodGhpcy5wbHVnaW5SZWYpID09PSB0cnVlO1xuICAgICAgICByZXR1cm4gaXNBdmFpbGFibGU7XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBvcmlnaW5hbCBwbHVnaW4gb2JqZWN0XG4gICAgICovXG4gICAgQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4uZ2V0UGx1Z2luID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIHJldHVybiBnZXQod2luZG93LCB0aGlzLnBsdWdpblJlZik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBwbHVnaW4ncyBuYW1lXG4gICAgICovXG4gICAgQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4uZ2V0UGx1Z2luTmFtZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHBsdWdpbk5hbWUgPSB0aGlzLnBsdWdpbk5hbWU7XG4gICAgICAgIHJldHVybiBwbHVnaW5OYW1lO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgcGx1Z2luJ3MgcmVmZXJlbmNlXG4gICAgICovXG4gICAgQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4uZ2V0UGx1Z2luUmVmID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgcGx1Z2luUmVmID0gdGhpcy5wbHVnaW5SZWY7XG4gICAgICAgIHJldHVybiBwbHVnaW5SZWY7XG4gICAgfTtcbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBwbHVnaW4ncyBpbnN0YWxsIG5hbWVcbiAgICAgKi9cbiAgICBBd2Vzb21lQ29yZG92YU5hdGl2ZVBsdWdpbi5nZXRQbHVnaW5JbnN0YWxsTmFtZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHBsdWdpbiA9IHRoaXMucGx1Z2luO1xuICAgICAgICByZXR1cm4gcGx1Z2luO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgcGx1Z2luJ3Mgc3VwcG9ydGVkIHBsYXRmb3Jtc1xuICAgICAqL1xuICAgIEF3ZXNvbWVDb3Jkb3ZhTmF0aXZlUGx1Z2luLmdldFN1cHBvcnRlZFBsYXRmb3JtcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHBsYXRmb3JtID0gdGhpcy5wbGF0Zm9ybXM7XG4gICAgICAgIHJldHVybiBwbGF0Zm9ybTtcbiAgICB9O1xuICAgIEF3ZXNvbWVDb3Jkb3ZhTmF0aXZlUGx1Z2luLnBsdWdpbk5hbWUgPSAnJztcbiAgICBBd2Vzb21lQ29yZG92YU5hdGl2ZVBsdWdpbi5wbHVnaW5SZWYgPSAnJztcbiAgICBBd2Vzb21lQ29yZG92YU5hdGl2ZVBsdWdpbi5wbHVnaW4gPSAnJztcbiAgICBBd2Vzb21lQ29yZG92YU5hdGl2ZVBsdWdpbi5yZXBvID0gJyc7XG4gICAgQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4ucGxhdGZvcm1zID0gW107XG4gICAgQXdlc29tZUNvcmRvdmFOYXRpdmVQbHVnaW4uaW5zdGFsbCA9ICcnO1xuICAgIHJldHVybiBBd2Vzb21lQ29yZG92YU5hdGl2ZVBsdWdpbjtcbn0oKSk7XG5cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIG1ldGhvZE5hbWVcbiAqIEBwYXJhbSBjb25maWdcbiAqIEBwYXJhbSBhcmdzXG4gKi9cbmZ1bmN0aW9uIGNvcmRvdmEocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBjb25maWcsIGFyZ3MpIHtcbiAgICByZXR1cm4gd3JhcChwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGNvbmZpZykuYXBwbHkodGhpcywgYXJncyk7XG59XG5cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIG1ldGhvZE5hbWVcbiAqL1xuZnVuY3Rpb24gb3ZlcnJpZGVGdW5jdGlvbihwbHVnaW5PYmosIG1ldGhvZE5hbWUpIHtcbiAgICByZXR1cm4gbmV3IHJ4anMuT2JzZXJ2YWJsZShmdW5jdGlvbiAob2JzZXJ2ZXIpIHtcbiAgICAgICAgdmFyIGF2YWlsYWJpbGl0eUNoZWNrID0gY2hlY2tBdmFpbGFiaWxpdHkocGx1Z2luT2JqLCBtZXRob2ROYW1lKTtcbiAgICAgICAgaWYgKGF2YWlsYWJpbGl0eUNoZWNrID09PSB0cnVlKSB7XG4gICAgICAgICAgICB2YXIgcGx1Z2luSW5zdGFuY2VfMSA9IGdldFBsdWdpbihwbHVnaW5PYmouY29uc3RydWN0b3IuZ2V0UGx1Z2luUmVmKCkpO1xuICAgICAgICAgICAgcGx1Z2luSW5zdGFuY2VfMVttZXRob2ROYW1lXSA9IG9ic2VydmVyLm5leHQuYmluZChvYnNlcnZlcik7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gKHBsdWdpbkluc3RhbmNlXzFbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbiAoKSB7IH0pOyB9O1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoYXZhaWxhYmlsaXR5Q2hlY2spO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuLyoqXG4gKiBAcGFyYW0gcGx1Z2luT2JqXG4gKiBAcGFyYW0gbWV0aG9kTmFtZVxuICogQHBhcmFtIGFyZ3NcbiAqL1xuZnVuY3Rpb24gY29yZG92YUZ1bmN0aW9uT3ZlcnJpZGUocGx1Z2luT2JqLCBtZXRob2ROYW1lLCBhcmdzKSB7XG4gICAgcmV0dXJuIG92ZXJyaWRlRnVuY3Rpb24ocGx1Z2luT2JqLCBtZXRob2ROYW1lKTtcbn1cblxuLyoqXG4gKiBAcGFyYW0gcGx1Z2luT2JqXG4gKiBAcGFyYW0gbWV0aG9kTmFtZVxuICogQHBhcmFtIGNvbmZpZ1xuICogQHBhcmFtIGFyZ3NcbiAqL1xuZnVuY3Rpb24gY29yZG92YUluc3RhbmNlKHBsdWdpbk9iaiwgbWV0aG9kTmFtZSwgY29uZmlnLCBhcmdzKSB7XG4gICAgYXJncyA9IEFycmF5LmZyb20oYXJncyk7XG4gICAgcmV0dXJuIHdyYXBJbnN0YW5jZShwbHVnaW5PYmosIG1ldGhvZE5hbWUsIGNvbmZpZykuYXBwbHkodGhpcywgYXJncyk7XG59XG5cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIGtleVxuICovXG5mdW5jdGlvbiBjb3Jkb3ZhUHJvcGVydHlHZXQocGx1Z2luT2JqLCBrZXkpIHtcbiAgICBpZiAoY2hlY2tBdmFpbGFiaWxpdHkocGx1Z2luT2JqLCBrZXkpID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybiBnZXRQbHVnaW4ocGx1Z2luT2JqLmNvbnN0cnVjdG9yLmdldFBsdWdpblJlZigpKVtrZXldO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbn1cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIGtleVxuICogQHBhcmFtIHZhbHVlXG4gKi9cbmZ1bmN0aW9uIGNvcmRvdmFQcm9wZXJ0eVNldChwbHVnaW5PYmosIGtleSwgdmFsdWUpIHtcbiAgICBpZiAoY2hlY2tBdmFpbGFiaWxpdHkocGx1Z2luT2JqLCBrZXkpID09PSB0cnVlKSB7XG4gICAgICAgIGdldFBsdWdpbihwbHVnaW5PYmouY29uc3RydWN0b3IuZ2V0UGx1Z2luUmVmKCkpW2tleV0gPSB2YWx1ZTtcbiAgICB9XG59XG5cbi8qKlxuICogQHBhcmFtIHBsdWdpbk9ialxuICogQHBhcmFtIGtleVxuICovXG5mdW5jdGlvbiBpbnN0YW5jZVByb3BlcnR5R2V0KHBsdWdpbk9iaiwga2V5KSB7XG4gICAgaWYgKHBsdWdpbk9iai5fb2JqZWN0SW5zdGFuY2UgJiYgcGx1Z2luT2JqLl9vYmplY3RJbnN0YW5jZVtrZXldKSB7XG4gICAgICAgIHJldHVybiBwbHVnaW5PYmouX29iamVjdEluc3RhbmNlW2tleV07XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuLyoqXG4gKiBAcGFyYW0gcGx1Z2luT2JqXG4gKiBAcGFyYW0ga2V5XG4gKiBAcGFyYW0gdmFsdWVcbiAqL1xuZnVuY3Rpb24gaW5zdGFuY2VQcm9wZXJ0eVNldChwbHVnaW5PYmosIGtleSwgdmFsdWUpIHtcbiAgICBpZiAocGx1Z2luT2JqLl9vYmplY3RJbnN0YW5jZSkge1xuICAgICAgICBwbHVnaW5PYmouX29iamVjdEluc3RhbmNlW2tleV0gPSB2YWx1ZTtcbiAgICB9XG59XG5cbmNoZWNrUmVhZHkoKTtcblxuZXhwb3J0cy5Bd2Vzb21lQ29yZG92YU5hdGl2ZVBsdWdpbiA9IEF3ZXNvbWVDb3Jkb3ZhTmF0aXZlUGx1Z2luO1xuZXhwb3J0cy5jaGVja0F2YWlsYWJpbGl0eSA9IGNoZWNrQXZhaWxhYmlsaXR5O1xuZXhwb3J0cy5jb3Jkb3ZhID0gY29yZG92YTtcbmV4cG9ydHMuY29yZG92YUZ1bmN0aW9uT3ZlcnJpZGUgPSBjb3Jkb3ZhRnVuY3Rpb25PdmVycmlkZTtcbmV4cG9ydHMuY29yZG92YUluc3RhbmNlID0gY29yZG92YUluc3RhbmNlO1xuZXhwb3J0cy5jb3Jkb3ZhUHJvcGVydHlHZXQgPSBjb3Jkb3ZhUHJvcGVydHlHZXQ7XG5leHBvcnRzLmNvcmRvdmFQcm9wZXJ0eVNldCA9IGNvcmRvdmFQcm9wZXJ0eVNldDtcbmV4cG9ydHMuZ2V0UHJvbWlzZSA9IGdldFByb21pc2U7XG5leHBvcnRzLmluc3RhbmNlQXZhaWxhYmlsaXR5ID0gaW5zdGFuY2VBdmFpbGFiaWxpdHk7XG5leHBvcnRzLmluc3RhbmNlUHJvcGVydHlHZXQgPSBpbnN0YW5jZVByb3BlcnR5R2V0O1xuZXhwb3J0cy5pbnN0YW5jZVByb3BlcnR5U2V0ID0gaW5zdGFuY2VQcm9wZXJ0eVNldDtcbmV4cG9ydHMud3JhcCA9IHdyYXA7XG4iXX0=